(()=>{"use strict";window.load={onData:(e,t,r,o,n)=>{const a=new XMLHttpRequest;a.addEventListener("load",(()=>{let r="";switch(a.status){case 200:e(a.response);break;default:r=`Статус ответа: ${a.status} ${a.statusText}`}r&&t(r)})),a.addEventListener("error",(()=>{t("Произошла ошибка соединения")})),a.addEventListener("timeout",(()=>{t("Запрос не успел выполниться за "+a.timeout+"мс")})),a.responseType="json",a.timeout=2e4,a.open(r,o),a.send(n)}},(()=>{let e=5;const t=document.querySelector("#pin").content.querySelector(".map__pin"),r=e=>{const r=t.cloneNode(!0),o=Number(e.location.x)-25,n=Number(e.location.y)-70;return r.style=`left: ${o}px; top: ${n}px;`,r.querySelector("img").src=e.author.avatar,r.querySelector("img").alt=e.offer.title,r};window.pin={render:t=>{const o=document.createDocumentFragment();e=t.length<5?t.length:5;for(let n=0;n<e;n++){const e=r(t[n]);e.setAttribute("data-index",n),o.appendChild(e)}return o}}})(),(()=>{const e={palace:"Дворец",house:"Дом",bungalow:"Бунгало",flat:"Квартира"},t=document.querySelector("#card").content.querySelector(".map__card");window.card={render:r=>{const o=t.cloneNode(!0);r.offer.title?o.querySelector(".popup__title").textContent=r.offer.title:o.querySelector(".popup__title").classList.add("visually-hidden"),r.offer.address?o.querySelector(".popup__text--address").textContent=r.offer.address:o.querySelector(".popup__text--address").classList.add("visually-hidden"),r.offer.price?o.querySelector(".popup__text--price").innerHTML=r.offer.price+"&#x20bd;<span>/ночь</span>":o.querySelector(".popup__text--price").classList.add("visually-hidden"),r.offer.type?o.querySelector(".popup__type").textContent=e[r.offer.type]:o.querySelector(".popup__type").classList.add("visually-hidden"),r.offer.rooms?o.querySelector(".popup__text--capacity").textContent=`${r.offer.rooms} комнаты для ${r.offer.guests} гостей`:o.querySelector(".popup__text--capacity").classList.add("visually-hidden"),r.offer.checkin&&r.offer.checkout?o.querySelector(".popup__text--time").textContent=`Заезд после ${r.offer.checkin}, выездо до ${r.offer.checkout}`:o.querySelector(".popup__text--time").classList.add("visually-hidden");const n=o.querySelector(".popup__features");for(;n.firstChild;)n.removeChild(n.firstChild);r.offer.features&&0!==r.offer.features.length?r.offer.features.forEach((e=>{const t=document.createElement("li");t.className="popup__feature popup__feature--"+e,n.appendChild(t)})):n.classList.add("visually-hidden"),r.offer.description?o.querySelector(".popup__description").textContent=r.offer.description:o.querySelector(".popup__description").classList.add("visually-hidden");const a=o.querySelector(".popup__photos");return r.offer.photos&&r.offer.photos.length>0?(r.offer.photos.forEach((e=>{const t=a.querySelector("img").cloneNode(!0);t.src=e,a.appendChild(t)})),a.children[0].remove()):a.classList.add("visually-hidden"),r.author.avatar?o.querySelector(".popup__avatar").src=r.author.avatar:o.querySelector(".popup__avatar").classList.add("visually-hidden"),o.querySelector(".popup__close").addEventListener("click",(()=>{o.classList.add("hidden")})),o}}})(),(()=>{const e="Количество гостей не соответствует количеству комнат: 1 комната - 1 гость, 2 комнаты - 1 или 2 гостя, 3 комнаты - 1, 2 или 3 гостя, 100 комнат - не для гостей",t={palace:1e4,house:5e3,bungalow:0,flat:1e3},r=document.querySelector(".ad-form"),o=document.querySelector("#title"),n=document.querySelector("#price"),a=document.querySelector("#address"),d=document.querySelector("#type"),s=document.querySelector("#timein"),i=document.querySelector("#timeout"),c=document.querySelector("#avatar"),l=document.querySelector("#images"),u=document.querySelector("#room_number"),p=document.querySelector("#capacity");r.setAttribute("action","https://javascript.pages.academy/keksobooking"),o.setAttribute("required","required"),o.setAttribute("minlength","30"),o.setAttribute("maxlength","100"),n.setAttribute("required","required"),n.setAttribute("max","1000000"),a.setAttribute("readonly","readonly"),c.setAttribute("accept","image/*"),l.setAttribute("accept","image/*"),n.setAttribute("min",t[d.options[d.selectedIndex].value]),n.setAttribute("placeholder",t[d.options[d.selectedIndex].value]),d.addEventListener("change",(e=>{n.setAttribute("min",t[d.options[e.currentTarget.selectedIndex].value]),n.setAttribute("placeholder",t[d.options[e.currentTarget.selectedIndex].value])}));const m=e=>{"timeout"===e.currentTarget.name?s.options.selectedIndex=i.options.selectedIndex:i.options.selectedIndex=s.options.selectedIndex};s.addEventListener("change",m),i.addEventListener("change",m);const y=t=>{u.setCustomValidity(e),p.setCustomValidity(e);const r=100===Number(u.options[u.selectedIndex].value),o=0===Number(p.options[p.selectedIndex].value),n=!r&&!o,a=o&&r;let d=u.options[u.selectedIndex].value>=p.options[p.selectedIndex].value;Boolean(t)&&"capacity"===t.currentTarget.name&&(d=p.options[p.selectedIndex].value<=u.options[u.selectedIndex].value),(n&&d||a)&&(u.setCustomValidity(""),p.setCustomValidity(""))};y(!1),u.addEventListener("change",y),p.addEventListener("change",y);const f=()=>{window.map.deactivatePage();const e=document.querySelector("#success").content.querySelector(".success").cloneNode(!0);document.querySelector("main").appendChild(e),e.setAttribute("tabindex","0"),e.focus(),e.addEventListener("click",(()=>{document.querySelector("main").removeChild(document.querySelector("main").lastChild)})),e.addEventListener("keydown",(e=>{"Escape"===e.key&&document.querySelector("main").removeChild(document.querySelector("main").lastChild)}))},v=e=>{const t=document.querySelector("#error").content.querySelector(".error").cloneNode(!0);t.querySelector("p").textContent=e,document.querySelector("main").appendChild(t),t.setAttribute("tabindex","0"),t.focus(),t.addEventListener("keydown",(e=>{"Escape"===e.key&&document.querySelector("main").removeChild(document.querySelector("main").lastChild)})),t.addEventListener("click",(()=>{document.querySelector("main").removeChild(document.querySelector("main").lastChild)})),t.querySelector(".error__button").addEventListener("click",(()=>{document.querySelector("main").removeChild(document.querySelector("main").lastChild)}))};r.addEventListener("submit",(e=>{e.preventDefault();let t=new FormData(r);window.load.onData(f,v,"POST","https://21.javascript.pages.academy/keksobooking",t)})),document.querySelector(".ad-form__reset").addEventListener("click",(e=>{e.preventDefault(),window.map.deactivatePage()}));const _=document.querySelector(".ad-form-header__upload input[type=file]"),h=document.querySelector(".ad-form-header__preview img");_.addEventListener("change",(()=>{const e=_.files[0],t=new FileReader;t.addEventListener("load",(()=>{h.src=t.result})),t.readAsDataURL(e)}));const w=document.querySelector(".ad-form__upload input[type=file]"),q=document.querySelector(".ad-form__photo"),S=document.createElement("img");q.style="display: flex; justify-content: center; align-items: center",S.alt="Фото жилья",S.width=40,S.height=44,q.appendChild(S),w.addEventListener("change",(()=>{const e=w.files[0],t=new FileReader;t.addEventListener("load",(()=>{S.src=t.result})),t.readAsDataURL(e)})),window.form={advert:r}})(),(()=>{let e=null;window.debounce=t=>{e&&window.clearTimeout(e),e=window.setTimeout(t,500)}})(),(()=>{const e=document.querySelector(".map__pin--main").offsetLeft+31,t=document.querySelector(".map__pin--main").offsetTop+31;let r=[],o=[];const n=document.querySelector(".map"),a=document.querySelector(".map__pin--main"),d=document.querySelector(".map__filters"),s=()=>{document.querySelector(".map__pins").appendChild(window.pin.render(o))},i=()=>{document.querySelectorAll(".map__pin:not(.map__pin--main").forEach((e=>{e.parentElement.removeChild(e)}))},c=e=>{let t=e.filter((e=>e.offer&&e.author&&e.location));r=t,o=t,d.classList.remove("ad-form--disabled"),Array.prototype.forEach.call(d.children,(e=>{e.removeAttribute("disabled")})),s()},l=e=>{const t=document.createElement("DIV");t.classList.add("error");const r=document.createElement("P");r.classList.add("error__message"),r.textContent=e,t.appendChild(r),t.setAttribute("tabindex","0"),t.focus(),document.querySelector("main").appendChild(t),t.addEventListener("click",(()=>{document.querySelector("main").removeChild(document.querySelector("main").lastChild)})),t.addEventListener("keydown",(e=>{"Escape"===e.key&&document.querySelector("main").removeChild(document.querySelector("main").lastChild)}))},u=()=>{n.classList.remove("map--faded"),window.form.advert.classList.remove("ad-form--disabled"),Array.prototype.forEach.call(window.form.advert.children,(e=>{e.removeAttribute("disabled")})),window.load.onData(c,l,"GET","https://21.javascript.pages.academy/keksobooking/data")},p=e=>{0===e.button&&(u(),a.removeEventListener("mousedown",p),a.removeEventListener("keydown",m))},m=e=>{"Enter"===e.key&&(u(),a.removeEventListener("mousedown",p),a.removeEventListener("keydown",m))};a.addEventListener("keydown",m),a.addEventListener("mousedown",p);const y=()=>{n.classList.add("map--faded"),window.form.advert.reset(),window.form.advert.classList.add("ad-form--disabled"),Array.prototype.forEach.call(window.form.advert.children,(e=>{e.setAttribute("disabled","disabled")})),d.reset(),d.classList.add("ad-form--disabled"),Array.prototype.forEach.call(d.children,(e=>{e.setAttribute("disabled","disabled")})),window.form.advert.querySelector("#address").setAttribute("value",e+", "+t),a.style.left=e-31+"px",a.style.top=t-31+"px",n.querySelector(".map__card")&&n.removeChild(n.querySelector(".map__card")),i(),a.addEventListener("keydown",m),a.addEventListener("mousedown",p)};y(),n.addEventListener("click",(e=>{let t=e.target;if("IMG"===t.tagName&&(t=t.parentNode),t.classList.contains("map__pin")&&!t.classList.contains("map__pin--main")){const e=document.querySelector(".map__pins .map__pin--active");e&&e.classList.remove("map__pin--active"),t.classList.add("map__pin--active"),n.querySelector(".map__card")&&n.removeChild(n.querySelector(".map__card")),n.insertBefore(window.card.render(o[t.dataset.index]),n.children[1])}})),n.addEventListener("keydown",(e=>{n.querySelector(".map__card")&&"Escape"===e.key&&n.querySelector(".map__card").classList.add("hidden")})),window.map={HALF_WIDTH_MAIN_PIN:31,HALF_HEIGHT_MAIN_PIN:31,adverts:n,pin:a,getRealEstate:()=>r,setFilteredRealEstates:e=>{o=e},deactivatePage:y,removePins:i,renderPinsJSON:s}})(),(()=>{const e={"housing-price":"price","housing-type":"type","housing-rooms":"rooms","housing-guests":"guests"},t=5e4,r=1e4,o=document.querySelector(".map__filters"),n=()=>{window.map.adverts.querySelector(".map__card")&&(window.map.adverts.querySelector(".map__card").classList.contains("hidden")||window.map.adverts.querySelector(".map__card").classList.add("hidden")),window.map.removePins();const n=new Map,a=[];o.querySelectorAll(":checked").forEach((t=>{"OPTION"===t.tagName&&n.set(e[t.parentNode.name],t.value),"INPUT"===t.tagName&&a.push(t.value)})),window.map.setFilteredRealEstates(window.map.getRealEstate().filter((e=>(e.offer.type===n.get("type")||"any"===n.get("type"))&&(e=>{let o=!1;switch(n.get("price")){case"middle":o=e<=t&&e>=r;break;case"high":o="high"===n.get("price")&&e>t;break;case"low":o="low"===n.get("price")&&e<r}return o||"any"===n.get("price")})(e.offer.price)&&(e.offer.rooms===Number(n.get("rooms"))||"any"===n.get("rooms"))&&(e.offer.guests===Number(n.get("guests"))||"any"===n.get("guests"))&&(e=>{let t=!0;return 0!==a.length&&0!==e.length?a.forEach((r=>{e.includes(r)||(t=!1)})):0!==a.length&&(t=!1),t})(e.offer.features)))),window.map.renderPinsJSON()};o.addEventListener("change",(()=>{window.debounce(n)})),o.addEventListener("keydown",(e=>{let t=e.target;"Enter"===e.key&&"INPUT"===t.tagName&&t.click()}))})(),(()=>{const e=(e,t)=>{let r=e.offsetLeft+window.map.HALF_WIDTH_MAIN_PIN,o=e.offsetTop+window.map.HALF_HEIGHT_MAIN_PIN;return t&&(o=e.offsetTop+82),`${r}, ${o}`};window.map.pin.addEventListener("mousedown",(t=>{t.preventDefault();let r={x:t.clientX,y:t.clientY},o=!1;const n=t=>{o=!0,t.preventDefault();let n=r.x-t.clientX,a=r.y-t.clientY;r={x:t.clientX,y:t.clientY};const d=Number(window.map.pin.offsetLeft-n),s=Number(window.map.pin.offsetTop-a),i=0-window.map.HALF_WIDTH_MAIN_PIN,c=document.querySelector(".map").clientWidth-window.map.HALF_WIDTH_MAIN_PIN;d>=i&&d<=c&&(window.map.pin.style.left=window.map.pin.offsetLeft-n+"px"),s>=48&&s<=548&&(window.map.pin.style.top=window.map.pin.offsetTop-a+"px"),window.form.advert.querySelector("#address").setAttribute("value",e(window.map.pin,o))},a=t=>{t.preventDefault(),window.form.advert.querySelector("#address").setAttribute("value",e(window.map.pin,o)),document.removeEventListener("mousemove",n),document.removeEventListener("mouseup",a)};document.addEventListener("mousemove",n),document.addEventListener("mouseup",a)}))})()})();