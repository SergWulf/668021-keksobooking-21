(()=>{"use strict";(()=>{const e=document.querySelector(".map__pin--main").offsetLeft+31,t=document.querySelector(".map__pin--main").offsetTop+31;window.data={COORDINATE_PIN_X:25,COORDINATE_PIN_Y:70,LEFT_MAP_PIN:e,TOP_MAP_PIN:t,HEIGHT_PIN_MAIN:82,WIDTH_PIN_MAIN:62,MIN_MAP_Y:130,MAX_MAP_Y:630,HALF_WIDTH_MAIN_PIN:31,HALF_HEIGHT_MAIN_PIN:31,TYPE_RESIDENCE:{palace:"Дворец",house:"Дом",bungalow:"Бунгало",flat:"Квартира"},TYPE_RESIDENCE_PRICE:{palace:1e4,house:5e3,bungalow:0,flat:1e3},realEstates:[],filterRealEstates:[],COUNT_SHOW_PINS:5,currentCountShowPins:5,URL_UPLOAD:"https://21.javascript.pages.academy/keksobooking",URL_DOWNLOAD:"https://21.javascript.pages.academy/keksobooking/data",FILTER_TYPE:{"housing-price":"price","housing-type":"type","housing-rooms":"rooms","housing-guests":"guests"},FILTER_PRICE:{high:5e4,low:1e4}}})(),window.load={onData:(e,t,o,r,a)=>{const n=new XMLHttpRequest;n.addEventListener("load",(()=>{let o="";switch(n.status){case 200:e(n.response);break;default:o=`Статус ответа: ${n.status} ${n.statusText}`}o&&t(o)})),n.addEventListener("error",(()=>{t("Произошла ошибка соединения")})),n.addEventListener("timeout",(()=>{t("Запрос не успел выполниться за "+n.timeout+"мс")})),n.responseType="json",n.timeout=2e4,n.open(o,r),n.send(a)}},(()=>{const e=document.querySelector("#pin").content.querySelector(".map__pin"),t=t=>{const o=e.cloneNode(!0),r=Number(t.location.x)-window.data.COORDINATE_PIN_X,a=Number(t.location.y)-window.data.COORDINATE_PIN_Y;return o.style=`left: ${r}px; top: ${a}px;`,o.querySelector("img").src=t.author.avatar,o.querySelector("img").alt=t.offer.title,o};window.pin={render:e=>{const o=document.createDocumentFragment();window.data.currentCountShowPins=e.length<window.data.COUNT_SHOW_PINS?e.length:window.data.COUNT_SHOW_PINS;for(let r=0;r<window.data.currentCountShowPins;r++){const a=t(e[r]);a.setAttribute("data-index",r),o.appendChild(a)}return o}}})(),(()=>{const e=document.querySelector("#card").content.querySelector(".map__card");window.card={render:t=>{const o=e.cloneNode(!0);t.offer.title?o.querySelector(".popup__title").textContent=t.offer.title:o.querySelector(".popup__title").classList.add("visually-hidden"),t.offer.address?o.querySelector(".popup__text--address").textContent=t.offer.address:o.querySelector(".popup__text--address").classList.add("visually-hidden"),t.offer.price?o.querySelector(".popup__text--price").innerHTML=t.offer.price+"&#x20bd;<span>/ночь</span>":o.querySelector(".popup__text--price").classList.add("visually-hidden"),t.offer.type?o.querySelector(".popup__type").textContent=window.data.TYPE_RESIDENCE[t.offer.type]:o.querySelector(".popup__type").classList.add("visually-hidden"),t.offer.rooms?o.querySelector(".popup__text--capacity").textContent=`${t.offer.rooms} комнаты для ${t.offer.guests} гостей`:o.querySelector(".popup__text--capacity").classList.add("visually-hidden"),t.offer.checkin&&t.offer.checkout?o.querySelector(".popup__text--time").textContent=`Заезд после ${t.offer.checkin}, выездо до ${t.offer.checkout}`:o.querySelector(".popup__text--time").classList.add("visually-hidden");const r=o.querySelector(".popup__features");for(;r.firstChild;)r.removeChild(r.firstChild);t.offer.features&&0!==t.offer.features.length?t.offer.features.forEach((e=>{const t=document.createElement("li");t.className="popup__feature popup__feature--"+e,r.appendChild(t)})):r.classList.add("visually-hidden"),t.offer.description?o.querySelector(".popup__description").textContent=t.offer.description:o.querySelector(".popup__description").classList.add("visually-hidden");const a=o.querySelector(".popup__photos");return t.offer.photos&&t.offer.photos.length>0?(t.offer.photos.forEach((e=>{const t=a.querySelector("img").cloneNode(!0);t.src=e,a.appendChild(t)})),a.children[0].remove()):a.classList.add("visually-hidden"),t.author.avatar?o.querySelector(".popup__avatar").src=t.author.avatar:o.querySelector(".popup__avatar").classList.add("visually-hidden"),o.querySelector(".popup__close").addEventListener("click",(()=>{o.classList.add("hidden")})),o}}})(),(()=>{const e="Количество гостей не соответствует количеству комнат: 1 комната - 1 гость, 2 комнаты - 1 или 2 гостя, 3 комнаты - 1, 2 или 3 гостя, 100 комнат - не для гостей",t=document.querySelector(".ad-form"),o=document.querySelector("#title"),r=document.querySelector("#price"),a=document.querySelector("#address"),n=document.querySelector("#type"),d=document.querySelector("#timein"),i=document.querySelector("#timeout"),s=document.querySelector("#avatar"),c=document.querySelector("#images"),l=document.querySelector("#room_number"),u=document.querySelector("#capacity");t.setAttribute("action","https://javascript.pages.academy/keksobooking"),o.setAttribute("required","required"),o.setAttribute("minlength","30"),o.setAttribute("maxlength","100"),r.setAttribute("required","required"),r.setAttribute("max","1000000"),a.setAttribute("readonly","readonly"),s.setAttribute("accept","image/*"),c.setAttribute("accept","image/*"),r.setAttribute("min",window.data.TYPE_RESIDENCE_PRICE[n.options[n.selectedIndex].value]),r.setAttribute("placeholder",window.data.TYPE_RESIDENCE_PRICE[n.options[n.selectedIndex].value]),n.addEventListener("change",(e=>{r.setAttribute("min",window.data.TYPE_RESIDENCE_PRICE[n.options[e.currentTarget.selectedIndex].value]),r.setAttribute("placeholder",window.data.TYPE_RESIDENCE_PRICE[n.options[e.currentTarget.selectedIndex].value])}));const p=e=>{"timeout"===e.currentTarget.name?d.options.selectedIndex=i.options.selectedIndex:i.options.selectedIndex=d.options.selectedIndex};d.addEventListener("change",p),i.addEventListener("change",p);const m=t=>{l.setCustomValidity(e),u.setCustomValidity(e);const o=100===Number(l.options[l.selectedIndex].value),r=0===Number(u.options[u.selectedIndex].value),a=!o&&!r,n=r&&o;let d=l.options[l.selectedIndex].value>=u.options[u.selectedIndex].value;Boolean(t)&&"capacity"===t.currentTarget.name&&(d=u.options[u.selectedIndex].value<=l.options[l.selectedIndex].value),(a&&d||n)&&(l.setCustomValidity(""),u.setCustomValidity(""))};m(!1),l.addEventListener("change",m),u.addEventListener("change",m);const _=()=>{window.map.deactivatePage();const e=document.querySelector("#success").content.querySelector(".success").cloneNode(!0);document.querySelector("main").appendChild(e),e.setAttribute("tabindex","0"),e.focus(),e.addEventListener("click",(()=>{document.querySelector("main").removeChild(document.querySelector("main").lastChild)})),e.addEventListener("keydown",(e=>{"Escape"===e.key&&document.querySelector("main").removeChild(document.querySelector("main").lastChild)}))},w=e=>{const t=document.querySelector("#error").content.querySelector(".error").cloneNode(!0);t.querySelector("p").textContent=e,document.querySelector("main").appendChild(t),t.setAttribute("tabindex","0"),t.focus(),t.addEventListener("keydown",(e=>{"Escape"===e.key&&document.querySelector("main").removeChild(document.querySelector("main").lastChild)})),t.addEventListener("click",(()=>{document.querySelector("main").removeChild(document.querySelector("main").lastChild)})),t.querySelector(".error__button").addEventListener("click",(()=>{document.querySelector("main").removeChild(document.querySelector("main").lastChild)}))};t.addEventListener("submit",(e=>{e.preventDefault();let o=new FormData(t);window.load.onData(_,w,"POST",window.data.URL_UPLOAD,o)})),document.querySelector(".ad-form__reset").addEventListener("click",(e=>{e.preventDefault(),window.map.deactivatePage()}));const y=document.querySelector(".ad-form-header__upload input[type=file]"),f=document.querySelector(".ad-form-header__preview img");y.addEventListener("change",(()=>{const e=y.files[0],t=new FileReader;t.addEventListener("load",(()=>{f.src=t.result})),t.readAsDataURL(e)}));const E=document.querySelector(".ad-form__upload input[type=file]"),v=document.querySelector(".ad-form__photo"),h=document.createElement("img");v.style="display: flex; justify-content: center; align-items: center",h.alt="Фото жилья",h.width=40,h.height=44,v.appendChild(h),E.addEventListener("change",(()=>{const e=E.files[0],t=new FileReader;t.addEventListener("load",(()=>{h.src=t.result})),t.readAsDataURL(e)})),window.form={advert:t}})(),(()=>{let e=null;window.debounce=t=>{e&&window.clearTimeout(e),e=window.setTimeout(t,500)}})(),(()=>{const e=document.querySelector(".map__filters"),t=()=>{window.map.adverts.querySelector(".map__card")&&(window.map.adverts.querySelector(".map__card").classList.contains("hidden")||window.map.adverts.querySelector(".map__card").classList.add("hidden")),window.map.removePins();const t=new Map,o=[];e.querySelectorAll(":checked").forEach((e=>{"OPTION"===e.tagName&&t.set(window.data.FILTER_TYPE[e.parentNode.name],e.value),"INPUT"===e.tagName&&o.push(e.value)})),window.data.filterRealEstates=window.data.realEstates.filter((e=>(e.offer.type===t.get("type")||"any"===t.get("type"))&&(e=>{let o=!1;switch(t.get("price")){case"middle":o=e<=window.data.FILTER_PRICE.high&&e>=window.data.FILTER_PRICE.low;break;case"high":o="high"===t.get("price")&&e>window.data.FILTER_PRICE.high;break;case"low":o="low"===t.get("price")&&e<window.data.FILTER_PRICE.low}return o||"any"===t.get("price")})(e.offer.price)&&(e.offer.rooms===Number(t.get("rooms"))||"any"===t.get("rooms"))&&(e.offer.guests===Number(t.get("guests"))||"any"===t.get("guests"))&&(e=>{let t=!0;return 0!==o.length&&0!==e.length?o.forEach((o=>{e.includes(o)||(t=!1)})):0!==o.length&&(t=!1),t})(e.offer.features))),window.map.renderPinsJSON()};e.addEventListener("change",(()=>{window.debounce(t)})),e.addEventListener("keydown",(e=>{let t=e.target;"Enter"===e.key&&"INPUT"===t.tagName&&t.click()})),window.filter={form:e,activateForm:()=>{e.classList.remove("ad-form--disabled"),Array.prototype.forEach.call(e.children,(e=>{e.removeAttribute("disabled")}))}}})(),(()=>{const e=document.querySelector(".map"),t=document.querySelector(".map__pin--main"),o=()=>{document.querySelector(".map__pins").appendChild(window.pin.render(window.data.filterRealEstates))},r=()=>{document.querySelectorAll(".map__pin:not(.map__pin--main").forEach((e=>{e.parentElement.removeChild(e)}))},a=e=>{let t=e.filter((e=>e.offer&&e.author&&e.location));window.data.realEstates=t,window.data.filterRealEstates=t,window.filter.activateForm(),o()},n=e=>{const t=document.createElement("DIV");t.classList.add("error");const o=document.createElement("P");o.classList.add("error__message"),o.textContent=e,t.appendChild(o),t.setAttribute("tabindex","0"),t.focus(),document.querySelector("main").appendChild(t),t.addEventListener("click",(()=>{document.querySelector("main").removeChild(document.querySelector("main").lastChild)})),t.addEventListener("keydown",(e=>{"Escape"===e.key&&document.querySelector("main").removeChild(document.querySelector("main").lastChild)}))},d=()=>{e.classList.remove("map--faded"),window.form.advert.classList.remove("ad-form--disabled"),Array.prototype.forEach.call(window.form.advert.children,(e=>{e.removeAttribute("disabled")})),window.load.onData(a,n,"GET",window.data.URL_DOWNLOAD)},i=e=>{0===e.button&&(d(),t.removeEventListener("mousedown",i),t.removeEventListener("keydown",s))},s=e=>{"Enter"===e.key&&(d(),t.removeEventListener("mousedown",i),t.removeEventListener("keydown",s))};t.addEventListener("keydown",s),t.addEventListener("mousedown",i);const c=()=>{e.classList.add("map--faded"),window.form.advert.reset(),window.form.advert.classList.add("ad-form--disabled"),Array.prototype.forEach.call(window.form.advert.children,(e=>{e.setAttribute("disabled","disabled")})),Array.prototype.forEach.call(window.filter.form.children,(e=>{e.setAttribute("disabled","disabled")})),window.form.advert.querySelector("#address").setAttribute("value",window.data.LEFT_MAP_PIN+", "+window.data.TOP_MAP_PIN),t.style.left=window.data.LEFT_MAP_PIN-window.data.HALF_WIDTH_MAIN_PIN+"px",t.style.top=window.data.TOP_MAP_PIN-window.data.HALF_HEIGHT_MAIN_PIN+"px",e.querySelector(".map__card")&&e.removeChild(e.querySelector(".map__card")),r(),t.addEventListener("keydown",s),t.addEventListener("mousedown",i)};c(),e.addEventListener("click",(t=>{let o=t.target;if("IMG"===o.tagName&&(o=o.parentNode),o.classList.contains("map__pin")&&!o.classList.contains("map__pin--main")){const t=document.querySelector(".map__pins .map__pin--active");t&&t.classList.remove("map__pin--active"),o.classList.add("map__pin--active"),e.querySelector(".map__card")&&e.removeChild(e.querySelector(".map__card")),e.insertBefore(window.card.render(window.data.filterRealEstates[o.dataset.index]),e.children[1])}})),e.addEventListener("keydown",(t=>{e.querySelector(".map__card")&&"Escape"===t.key&&e.querySelector(".map__card").classList.add("hidden")})),window.map={adverts:e,pin:t,deactivatePage:c,removePins:r,renderPinsJSON:o}})(),(()=>{const e=(e,t)=>{let o=e.offsetLeft+window.data.HALF_WIDTH_MAIN_PIN,r=e.offsetTop+window.data.HALF_HEIGHT_MAIN_PIN;return t&&(r=e.offsetTop+window.data.HEIGHT_PIN_MAIN),`${o}, ${r}`};window.map.pin.addEventListener("mousedown",(t=>{t.preventDefault();let o={x:t.clientX,y:t.clientY},r=!1;const a=t=>{r=!0,t.preventDefault();let a=o.x-t.clientX,n=o.y-t.clientY;o={x:t.clientX,y:t.clientY};const d=Number(window.map.pin.offsetLeft-a),i=Number(window.map.pin.offsetTop-n),s=0-window.data.HALF_WIDTH_MAIN_PIN,c=document.querySelector(".map").clientWidth-window.data.HALF_WIDTH_MAIN_PIN,l=window.data.MIN_MAP_Y-window.data.HEIGHT_PIN_MAIN,u=window.data.MAX_MAP_Y-window.data.HEIGHT_PIN_MAIN;d>=s&&d<=c&&(window.map.pin.style.left=window.map.pin.offsetLeft-a+"px"),i>=l&&i<=u&&(window.map.pin.style.top=window.map.pin.offsetTop-n+"px"),window.form.advert.querySelector("#address").setAttribute("value",e(window.map.pin,r))},n=t=>{t.preventDefault(),window.form.advert.querySelector("#address").setAttribute("value",e(window.map.pin,r)),document.removeEventListener("mousemove",a),document.removeEventListener("mouseup",n)};document.addEventListener("mousemove",a),document.addEventListener("mouseup",n)}))})()})();