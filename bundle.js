(()=>{"use strict";window.load={requestData:(e,t,o,n,r)=>{const d=new XMLHttpRequest;d.addEventListener("load",(()=>{let o="";switch(d.status){case 200:e(d.response);break;default:o=`Статус ответа: ${d.status} ${d.statusText}`}o&&t(o)})),d.addEventListener("error",(()=>{t("Произошла ошибка соединения")})),d.addEventListener("timeout",(()=>{t("Запрос не успел выполниться за "+d.timeout+"мс")})),d.responseType="json",d.timeout=2e4,d.open(o,n),d.send(r)}},(()=>{let e=null;window.util={ESCAPE:"Escape",ENTER:"Enter",INPUT:"INPUT",OPTION:"OPTION",SRC_DEFAULT_IMAGE:"img/muffin-grey.svg",Method:{GET:"GET",POST:"POST"},debounce:t=>{e&&window.clearTimeout(e),e=window.setTimeout(t,500)}}})(),(()=>{let e=5;const t=document.querySelector("#pin").content.querySelector(".map__pin"),o=e=>{const o=t.cloneNode(!0),n=Number(e.location.x)-25,r=Number(e.location.y)-70;o.style=`left: ${n}px; top: ${r}px;`;const d=o.querySelector("img");return d.src=e.author.avatar,d.alt=e.offer.title,o};window.pin={render:t=>{const n=document.createDocumentFragment();e=t.length<5?t.length:5;for(let r=0;r<e;r++){const e=o(t[r]);e.setAttribute("data-index",r),n.appendChild(e)}return n}}})(),(()=>{const e={palace:"Дворец",house:"Дом",bungalow:"Бунгало",flat:"Квартира"},t=document.querySelector("#card").content.querySelector(".map__card");window.card={render:o=>{const n=t.cloneNode(!0),r=n.querySelector(".popup__title");o.offer.title?r.textContent=o.offer.title:r.classList.add("visually-hidden");const d=n.querySelector(".popup__text--address");o.offer.address?d.textContent=o.offer.address:d.classList.add("visually-hidden");const a=n.querySelector(".popup__text--price");o.offer.price?a.textContent=`${o.offer.price} ${a.textContent}`:a.classList.add("visually-hidden");const s=n.querySelector(".popup__type");o.offer.type?s.textContent=e[o.offer.type]:s.classList.add("visually-hidden");const i=n.querySelector(".popup__text--capacity");o.offer.rooms?i.textContent=`${o.offer.rooms} комнаты для ${o.offer.guests} гостей`:i.classList.add("visually-hidden");const c=n.querySelector(".popup__text--time");o.offer.checkin&&o.offer.checkout?c.textContent=`Заезд после ${o.offer.checkin}, выездо до ${o.offer.checkout}`:c.classList.add("visually-hidden");const l=n.querySelector(".popup__features");for(;l.firstChild;)l.removeChild(l.firstChild);o.offer.features&&0!==o.offer.features.length?o.offer.features.forEach((e=>{const t=document.createElement("li");t.className="popup__feature popup__feature--"+e,l.appendChild(t)})):l.classList.add("visually-hidden");const u=n.querySelector(".popup__description");o.offer.description?u.textContent=o.offer.description:u.classList.add("visually-hidden");const p=n.querySelector(".popup__photos");o.offer.photos&&o.offer.photos.length>0?(o.offer.photos.forEach((e=>{const t=p.querySelector("img").cloneNode(!0);t.src=e,p.appendChild(t)})),p.children[0].remove()):p.classList.add("visually-hidden");const m=n.querySelector(".popup__avatar");return o.author.avatar?m.src=o.author.avatar:m.classList.add("visually-hidden"),n}}})(),(()=>{const e={palace:1e4,house:5e3,bungalow:0,flat:1e3},t=document.querySelector(".ad-form"),o=document.querySelector("#price"),n=document.querySelector("#type"),r=document.querySelector("#timein"),d=document.querySelector("#timeout"),a=document.querySelector("#room_number"),s=document.querySelector("#capacity"),i=()=>{o.setAttribute("min",""+e.flat),o.setAttribute("placeholder",""+e.flat)};n.addEventListener("change",(t=>{o.setAttribute("min",e[n.options[t.currentTarget.selectedIndex].value]),o.setAttribute("placeholder",e[n.options[t.currentTarget.selectedIndex].value])})),r.addEventListener("change",(()=>{d.options.selectedIndex=r.options.selectedIndex})),d.addEventListener("change",(()=>{r.options.selectedIndex=d.options.selectedIndex}));const c=()=>{s.setCustomValidity("Количество гостей не соответствует количеству комнат: 1 комната - 1 гость, 2 комнаты - 1 или 2 гостя, 3 комнаты - 1, 2 или 3 гостя, 100 комнат - не для гостей");const e=100===Number(a.options[a.selectedIndex].value),t=0===Number(s.options[s.selectedIndex].value),o=!e&&!t,n=t&&e;let r=a.options[a.selectedIndex].value>=s.options[s.selectedIndex].value;(o&&r||n)&&s.setCustomValidity("")};a.addEventListener("change",(()=>{c()})),s.addEventListener("change",(()=>{c()}));const l=document.querySelector("main"),u=document.querySelector(".ad-form-header__upload input[type=file]"),p=document.querySelector(".ad-form-header__preview img");u.addEventListener("change",(()=>{const e=u.files[0],t=new FileReader;t.addEventListener("load",(()=>{p.src=t.result})),t.readAsDataURL(e)}));const m=document.querySelector(".ad-form__upload input[type=file]"),f=document.querySelector(".ad-form__photo"),v=f.querySelector("img");f.style="display: flex; justify-content: center; align-items: center",m.addEventListener("change",(()=>{const e=m.files[0],t=new FileReader;t.addEventListener("load",(()=>{v.src=t.result})),t.readAsDataURL(e)}));const y=()=>{v.src=window.util.SRC_DEFAULT_IMAGE,p.src=window.util.SRC_DEFAULT_IMAGE},w=()=>{window.map.deactivatePage(),i(),y();const e=document.querySelector("#success").content.querySelector(".success").cloneNode(!0);l.appendChild(e),e.setAttribute("tabindex","0"),e.focus(),e.addEventListener("click",(()=>{l.removeChild(l.lastChild)})),e.addEventListener("keydown",(e=>{"Escape"===e.key&&l.removeChild(l.lastChild)}))},h=e=>{const t=document.querySelector("#error").content.querySelector(".error").cloneNode(!0);t.querySelector("p").textContent=e,l.appendChild(t),t.setAttribute("tabindex","0"),t.focus(),t.addEventListener("keydown",(e=>{"Escape"===e.key&&l.removeChild(l.lastChild)})),t.addEventListener("click",(()=>{l.removeChild(l.lastChild)})),t.querySelector(".error__button").addEventListener("click",(()=>{l.removeChild(l.lastChild)}))};t.addEventListener("submit",(e=>{e.preventDefault();let o=new FormData(t);window.load.requestData(w,h,"POST","https://21.javascript.pages.academy/keksobooking",o)})),document.querySelector(".ad-form__reset").addEventListener("click",(e=>{e.preventDefault(),window.map.deactivatePage(),i(),y()})),window.form={advert:t}})(),(()=>{const e=document.querySelector(".map"),t=document.querySelector(".map__pin--main"),o=document.querySelector(".map__filters");let n=[],r=[];const d=()=>{document.querySelector(".map__pins").appendChild(window.pin.render(r))},a=()=>{document.querySelectorAll(".map__pin:not(.map__pin--main)").forEach((e=>{e.parentElement.removeChild(e)}))},s=e=>{let t=e.filter((e=>e.offer&&e.author&&e.location));n=t,r=t,o.classList.remove("ad-form--disabled"),Array.prototype.forEach.call(o.children,(e=>{e.removeAttribute("disabled")})),d()},i=e=>{const t=document.querySelector("main"),o=document.createElement("DIV");o.classList.add("error");const n=document.createElement("P");n.classList.add("error__message"),n.textContent=e,o.appendChild(n),o.setAttribute("tabindex","0"),o.focus(),t.appendChild(o),o.addEventListener("click",(()=>{t.removeChild(t.lastChild)})),o.addEventListener("keydown",(e=>{"Escape"===e.key&&t.removeChild(t.lastChild)}))},c=()=>{e.classList.remove("map--faded"),window.form.advert.classList.remove("ad-form--disabled"),Array.prototype.forEach.call(window.form.advert.children,(e=>{e.removeAttribute("disabled")})),window.load.requestData(s,i,"GET","https://21.javascript.pages.academy/keksobooking/data")},l=e=>{0===e.button&&(c(),t.removeEventListener("mousedown",l),t.removeEventListener("keydown",u))},u=e=>{"Enter"===e.key&&(c(),t.removeEventListener("mousedown",l),t.removeEventListener("keydown",u))};t.addEventListener("keydown",u),t.addEventListener("mousedown",l);const p=()=>{const t=e.querySelector(".map__card");t&&e.removeChild(t)},m=()=>{document.removeEventListener("click",v),document.removeEventListener("keydown",y)},f=()=>{e.classList.add("map--faded"),window.form.advert.reset(),window.form.advert.classList.add("ad-form--disabled"),Array.prototype.forEach.call(window.form.advert.children,(e=>{e.setAttribute("disabled","disabled")})),o.reset(),o.classList.add("ad-form--disabled"),Array.prototype.forEach.call(o.children,(e=>{e.setAttribute("disabled","disabled")})),window.form.advert.querySelector("#address").setAttribute("value","601, 406"),t.style.left="570px",t.style.top="375px",p(),a(),t.addEventListener("keydown",u),t.addEventListener("mousedown",l)};f();const v=()=>{p(),m()},y=e=>{"Escape"===e.key&&(p(),m())};e.addEventListener("click",(t=>{let o=t.target;if("IMG"===o.tagName&&(o=o.parentNode),o.classList.contains("map__pin")&&!o.classList.contains("map__pin--main")){const t=document.querySelector(".map__pins .map__pin--active");t&&t.classList.remove("map__pin--active"),o.classList.add("map__pin--active"),p(),e.insertBefore(window.card.render(r[o.dataset.index]),e.children[1]),document.querySelector(".popup__close").addEventListener("click",v),document.addEventListener("keydown",y)}})),window.map={HALF_WIDTH_MAIN_PIN:31,HALF_HEIGHT_MAIN_PIN:31,adverts:e,pin:t,getRealEstate:()=>n,setFilteredRealEstates:e=>{r=e},deactivatePage:f,removePins:a,renderPinsJSON:d}})(),(()=>{const e={"housing-price":"price","housing-type":"type","housing-rooms":"rooms","housing-guests":"guests"},t=5e4,o=1e4,n=document.querySelector(".map__filters"),r=()=>{const r=window.map.adverts.querySelector(".map__card");r&&(r.classList.contains("visually-hidden")||r.classList.add("visually-hidden")),window.map.removePins();const d=new Map,a=[];n.querySelectorAll(":checked").forEach((t=>{"OPTION"===t.tagName&&d.set(e[t.parentNode.name],t.value),"INPUT"===t.tagName&&a.push(t.value)})),window.map.setFilteredRealEstates(window.map.getRealEstate().filter((e=>(e.offer.type===d.get("type")||"any"===d.get("type"))&&(e=>{let n=!1;switch(d.get("price")){case"middle":n=e<=t&&e>=o;break;case"high":n="high"===d.get("price")&&e>t;break;case"low":n="low"===d.get("price")&&e<o}return n||"any"===d.get("price")})(e.offer.price)&&(e.offer.rooms===Number(d.get("rooms"))||"any"===d.get("rooms"))&&(e.offer.guests===Number(d.get("guests"))||"any"===d.get("guests"))&&(e=>{let t=!0;return 0!==a.length&&0!==e.length?a.forEach((o=>{e.includes(o)||(t=!1)})):0!==a.length&&(t=!1),t})(e.offer.features)))),window.map.renderPinsJSON()};n.addEventListener("change",(()=>{window.util.debounce(r)})),n.addEventListener("keydown",(e=>{let t=e.target;"Enter"===e.key&&"INPUT"===t.tagName&&t.click()}))})(),(()=>{const e=(e,t)=>{let o=e.offsetLeft+window.map.HALF_WIDTH_MAIN_PIN,n=e.offsetTop+window.map.HALF_HEIGHT_MAIN_PIN;return t&&(n=e.offsetTop+82),`${o}, ${n}`};window.map.pin.addEventListener("mousedown",(t=>{t.preventDefault();let o={x:t.clientX,y:t.clientY},n=!1;const r=t=>{n=!0,t.preventDefault();let r=o.x-t.clientX,d=o.y-t.clientY;o={x:t.clientX,y:t.clientY};const a=Number(window.map.pin.offsetLeft-r),s=Number(window.map.pin.offsetTop-d),i=0-window.map.HALF_WIDTH_MAIN_PIN,c=document.querySelector(".map").clientWidth-window.map.HALF_WIDTH_MAIN_PIN;a>=i&&a<=c&&(window.map.pin.style.left=window.map.pin.offsetLeft-r+"px"),s>=48&&s<=548&&(window.map.pin.style.top=window.map.pin.offsetTop-d+"px"),window.form.advert.querySelector("#address").setAttribute("value",e(window.map.pin,n))},d=t=>{t.preventDefault(),window.form.advert.querySelector("#address").setAttribute("value",e(window.map.pin,n)),document.removeEventListener("mousemove",r),document.removeEventListener("mouseup",d)};document.addEventListener("mousemove",r),document.addEventListener("mouseup",d)}))})()})();