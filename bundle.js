(()=>{"use strict";window.load={onData:(e,t,o,r,n)=>{const a=new XMLHttpRequest;a.addEventListener("load",(()=>{let o="";switch(a.status){case 200:e(a.response);break;default:o=`Статус ответа: ${a.status} ${a.statusText}`}o&&t(o)})),a.addEventListener("error",(()=>{t("Произошла ошибка соединения")})),a.addEventListener("timeout",(()=>{t("Запрос не успел выполниться за "+a.timeout+"мс")})),a.responseType="json",a.timeout=2e4,a.open(o,r),a.send(n)}},(()=>{let e=5;const t=document.querySelector("#pin").content.querySelector(".map__pin"),o=e=>{const o=t.cloneNode(!0),r=Number(e.location.x)-25,n=Number(e.location.y)-70;return o.style=`left: ${r}px; top: ${n}px;`,o.querySelector("img").src=e.author.avatar,o.querySelector("img").alt=e.offer.title,o};window.pin={render:t=>{const r=document.createDocumentFragment();e=t.length<5?t.length:5;for(let n=0;n<e;n++){const e=o(t[n]);e.setAttribute("data-index",n),r.appendChild(e)}return r}}})(),(()=>{const e={palace:"Дворец",house:"Дом",bungalow:"Бунгало",flat:"Квартира"},t=document.querySelector("#card").content.querySelector(".map__card");window.card={render:o=>{const r=t.cloneNode(!0);o.offer.title?r.querySelector(".popup__title").textContent=o.offer.title:r.querySelector(".popup__title").classList.add("visually-hidden"),o.offer.address?r.querySelector(".popup__text--address").textContent=o.offer.address:r.querySelector(".popup__text--address").classList.add("visually-hidden"),o.offer.price?r.querySelector(".popup__text--price").innerHTML=o.offer.price+"&#x20bd;<span>/ночь</span>":r.querySelector(".popup__text--price").classList.add("visually-hidden"),o.offer.type?r.querySelector(".popup__type").textContent=e[o.offer.type]:r.querySelector(".popup__type").classList.add("visually-hidden"),o.offer.rooms?r.querySelector(".popup__text--capacity").textContent=`${o.offer.rooms} комнаты для ${o.offer.guests} гостей`:r.querySelector(".popup__text--capacity").classList.add("visually-hidden"),o.offer.checkin&&o.offer.checkout?r.querySelector(".popup__text--time").textContent=`Заезд после ${o.offer.checkin}, выездо до ${o.offer.checkout}`:r.querySelector(".popup__text--time").classList.add("visually-hidden");const n=r.querySelector(".popup__features");for(;n.firstChild;)n.removeChild(n.firstChild);o.offer.features&&0!==o.offer.features.length?o.offer.features.forEach((e=>{const t=document.createElement("li");t.className="popup__feature popup__feature--"+e,n.appendChild(t)})):n.classList.add("visually-hidden"),o.offer.description?r.querySelector(".popup__description").textContent=o.offer.description:r.querySelector(".popup__description").classList.add("visually-hidden");const a=r.querySelector(".popup__photos");return o.offer.photos&&o.offer.photos.length>0?(o.offer.photos.forEach((e=>{const t=a.querySelector("img").cloneNode(!0);t.src=e,a.appendChild(t)})),a.children[0].remove()):a.classList.add("visually-hidden"),o.author.avatar?r.querySelector(".popup__avatar").src=o.author.avatar:r.querySelector(".popup__avatar").classList.add("visually-hidden"),r.querySelector(".popup__close").addEventListener("click",(()=>{r.classList.add("hidden")})),r}}})(),(()=>{const e="Количество гостей не соответствует количеству комнат: 1 комната - 1 гость, 2 комнаты - 1 или 2 гостя, 3 комнаты - 1, 2 или 3 гостя, 100 комнат - не для гостей",t={palace:1e4,house:5e3,bungalow:0,flat:1e3},o=document.querySelector(".ad-form"),r=document.querySelector("#price"),n=document.querySelector("#type"),a=document.querySelector("#timein"),d=document.querySelector("#timeout"),s=document.querySelector("#room_number"),i=document.querySelector("#capacity");r.setAttribute("min",t[n.options[n.selectedIndex].value]),r.setAttribute("placeholder",t[n.options[n.selectedIndex].value]),n.addEventListener("change",(e=>{r.setAttribute("min",t[n.options[e.currentTarget.selectedIndex].value]),r.setAttribute("placeholder",t[n.options[e.currentTarget.selectedIndex].value])}));const c=e=>{"timeout"===e.currentTarget.name?a.options.selectedIndex=d.options.selectedIndex:d.options.selectedIndex=a.options.selectedIndex};a.addEventListener("change",c),d.addEventListener("change",c);const l=t=>{s.setCustomValidity(e),i.setCustomValidity(e);const o=100===Number(s.options[s.selectedIndex].value),r=0===Number(i.options[i.selectedIndex].value),n=!o&&!r,a=r&&o;let d=s.options[s.selectedIndex].value>=i.options[i.selectedIndex].value;Boolean(t)&&"capacity"===t.currentTarget.name&&(d=i.options[i.selectedIndex].value<=s.options[s.selectedIndex].value),(n&&d||a)&&(s.setCustomValidity(""),i.setCustomValidity(""))};l(!1),s.addEventListener("change",l),i.addEventListener("change",l);const u=()=>{window.map.deactivatePage();const e=document.querySelector("#success").content.querySelector(".success").cloneNode(!0);document.querySelector("main").appendChild(e),e.setAttribute("tabindex","0"),e.focus(),e.addEventListener("click",(()=>{document.querySelector("main").removeChild(document.querySelector("main").lastChild)})),e.addEventListener("keydown",(e=>{"Escape"===e.key&&document.querySelector("main").removeChild(document.querySelector("main").lastChild)}))},p=e=>{const t=document.querySelector("#error").content.querySelector(".error").cloneNode(!0);t.querySelector("p").textContent=e,document.querySelector("main").appendChild(t),t.setAttribute("tabindex","0"),t.focus(),t.addEventListener("keydown",(e=>{"Escape"===e.key&&document.querySelector("main").removeChild(document.querySelector("main").lastChild)})),t.addEventListener("click",(()=>{document.querySelector("main").removeChild(document.querySelector("main").lastChild)})),t.querySelector(".error__button").addEventListener("click",(()=>{document.querySelector("main").removeChild(document.querySelector("main").lastChild)}))};o.addEventListener("submit",(e=>{e.preventDefault();let t=new FormData(o);window.load.onData(u,p,"POST","https://21.javascript.pages.academy/keksobooking",t)})),document.querySelector(".ad-form__reset").addEventListener("click",(e=>{e.preventDefault(),window.map.deactivatePage()}));const m=document.querySelector(".ad-form-header__upload input[type=file]"),y=document.querySelector(".ad-form-header__preview img");m.addEventListener("change",(()=>{const e=m.files[0],t=new FileReader;t.addEventListener("load",(()=>{y.src=t.result})),t.readAsDataURL(e)}));const f=document.querySelector(".ad-form__upload input[type=file]"),_=document.querySelector(".ad-form__photo"),v=document.createElement("img");_.style="display: flex; justify-content: center; align-items: center",v.alt="Фото жилья",v.width=40,v.height=44,_.appendChild(v),f.addEventListener("change",(()=>{const e=f.files[0],t=new FileReader;t.addEventListener("load",(()=>{v.src=t.result})),t.readAsDataURL(e)})),window.form={advert:o}})(),(()=>{let e=null;window.debounce=t=>{e&&window.clearTimeout(e),e=window.setTimeout(t,500)}})(),(()=>{const e=document.querySelector(".map__pin--main").offsetLeft+31,t=document.querySelector(".map__pin--main").offsetTop+31;let o=[],r=[];const n=document.querySelector(".map"),a=document.querySelector(".map__pin--main"),d=document.querySelector(".map__filters"),s=()=>{document.querySelector(".map__pins").appendChild(window.pin.render(r))},i=()=>{document.querySelectorAll(".map__pin:not(.map__pin--main").forEach((e=>{e.parentElement.removeChild(e)}))},c=e=>{let t=e.filter((e=>e.offer&&e.author&&e.location));o=t,r=t,d.classList.remove("ad-form--disabled"),Array.prototype.forEach.call(d.children,(e=>{e.removeAttribute("disabled")})),s()},l=e=>{const t=document.createElement("DIV");t.classList.add("error");const o=document.createElement("P");o.classList.add("error__message"),o.textContent=e,t.appendChild(o),t.setAttribute("tabindex","0"),t.focus(),document.querySelector("main").appendChild(t),t.addEventListener("click",(()=>{document.querySelector("main").removeChild(document.querySelector("main").lastChild)})),t.addEventListener("keydown",(e=>{"Escape"===e.key&&document.querySelector("main").removeChild(document.querySelector("main").lastChild)}))},u=()=>{n.classList.remove("map--faded"),window.form.advert.classList.remove("ad-form--disabled"),Array.prototype.forEach.call(window.form.advert.children,(e=>{e.removeAttribute("disabled")})),window.load.onData(c,l,"GET","https://21.javascript.pages.academy/keksobooking/data")},p=e=>{0===e.button&&(u(),a.removeEventListener("mousedown",p),a.removeEventListener("keydown",m))},m=e=>{"Enter"===e.key&&(u(),a.removeEventListener("mousedown",p),a.removeEventListener("keydown",m))};a.addEventListener("keydown",m),a.addEventListener("mousedown",p);const y=()=>{n.classList.add("map--faded"),window.form.advert.reset(),window.form.advert.classList.add("ad-form--disabled"),Array.prototype.forEach.call(window.form.advert.children,(e=>{e.setAttribute("disabled","disabled")})),d.reset(),d.classList.add("ad-form--disabled"),Array.prototype.forEach.call(d.children,(e=>{e.setAttribute("disabled","disabled")})),window.form.advert.querySelector("#address").setAttribute("value",e+", "+t),a.style.left=e-31+"px",a.style.top=t-31+"px",n.querySelector(".map__card")&&n.removeChild(n.querySelector(".map__card")),i(),a.addEventListener("keydown",m),a.addEventListener("mousedown",p)};y(),n.addEventListener("click",(e=>{let t=e.target;if("IMG"===t.tagName&&(t=t.parentNode),t.classList.contains("map__pin")&&!t.classList.contains("map__pin--main")){const e=document.querySelector(".map__pins .map__pin--active");e&&e.classList.remove("map__pin--active"),t.classList.add("map__pin--active"),n.querySelector(".map__card")&&n.removeChild(n.querySelector(".map__card")),n.insertBefore(window.card.render(r[t.dataset.index]),n.children[1])}})),n.addEventListener("keydown",(e=>{n.querySelector(".map__card")&&"Escape"===e.key&&n.querySelector(".map__card").classList.add("hidden")})),window.map={HALF_WIDTH_MAIN_PIN:31,HALF_HEIGHT_MAIN_PIN:31,adverts:n,pin:a,getRealEstate:()=>o,setFilteredRealEstates:e=>{r=e},deactivatePage:y,removePins:i,renderPinsJSON:s}})(),(()=>{const e={"housing-price":"price","housing-type":"type","housing-rooms":"rooms","housing-guests":"guests"},t=5e4,o=1e4,r=document.querySelector(".map__filters"),n=()=>{window.map.adverts.querySelector(".map__card")&&(window.map.adverts.querySelector(".map__card").classList.contains("hidden")||window.map.adverts.querySelector(".map__card").classList.add("hidden")),window.map.removePins();const n=new Map,a=[];r.querySelectorAll(":checked").forEach((t=>{"OPTION"===t.tagName&&n.set(e[t.parentNode.name],t.value),"INPUT"===t.tagName&&a.push(t.value)})),window.map.setFilteredRealEstates(window.map.getRealEstate().filter((e=>(e.offer.type===n.get("type")||"any"===n.get("type"))&&(e=>{let r=!1;switch(n.get("price")){case"middle":r=e<=t&&e>=o;break;case"high":r="high"===n.get("price")&&e>t;break;case"low":r="low"===n.get("price")&&e<o}return r||"any"===n.get("price")})(e.offer.price)&&(e.offer.rooms===Number(n.get("rooms"))||"any"===n.get("rooms"))&&(e.offer.guests===Number(n.get("guests"))||"any"===n.get("guests"))&&(e=>{let t=!0;return 0!==a.length&&0!==e.length?a.forEach((o=>{e.includes(o)||(t=!1)})):0!==a.length&&(t=!1),t})(e.offer.features)))),window.map.renderPinsJSON()};r.addEventListener("change",(()=>{window.debounce(n)})),r.addEventListener("keydown",(e=>{let t=e.target;"Enter"===e.key&&"INPUT"===t.tagName&&t.click()}))})(),(()=>{const e=(e,t)=>{let o=e.offsetLeft+window.map.HALF_WIDTH_MAIN_PIN,r=e.offsetTop+window.map.HALF_HEIGHT_MAIN_PIN;return t&&(r=e.offsetTop+82),`${o}, ${r}`};window.map.pin.addEventListener("mousedown",(t=>{t.preventDefault();let o={x:t.clientX,y:t.clientY},r=!1;const n=t=>{r=!0,t.preventDefault();let n=o.x-t.clientX,a=o.y-t.clientY;o={x:t.clientX,y:t.clientY};const d=Number(window.map.pin.offsetLeft-n),s=Number(window.map.pin.offsetTop-a),i=0-window.map.HALF_WIDTH_MAIN_PIN,c=document.querySelector(".map").clientWidth-window.map.HALF_WIDTH_MAIN_PIN;d>=i&&d<=c&&(window.map.pin.style.left=window.map.pin.offsetLeft-n+"px"),s>=48&&s<=548&&(window.map.pin.style.top=window.map.pin.offsetTop-a+"px"),window.form.advert.querySelector("#address").setAttribute("value",e(window.map.pin,r))},a=t=>{t.preventDefault(),window.form.advert.querySelector("#address").setAttribute("value",e(window.map.pin,r)),document.removeEventListener("mousemove",n),document.removeEventListener("mouseup",a)};document.addEventListener("mousemove",n),document.addEventListener("mouseup",a)}))})()})();